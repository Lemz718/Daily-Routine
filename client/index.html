<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily-Routine Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4A90E2">
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>(function(){emailjs.init("VlJaZ1nveYq7yEHV3");})();</script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary: #4A90E2; --bg: #f8fbff; --card: #ffffff; --text: #333333;
            --text-muted: #888888; --border: #eeeeee; --hover-bg: #f0f7ff;
            --body-bg: #e0e7ff; --sidebar-width: 280px;
        }

        body.dark-theme {
            --primary: #63a4ff; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0;
            --text-muted: #aaaaaa; --border: #333333; --hover-bg: #2a2a2a; --body-bg: #0a0a0a;
        }
        body { font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--body-bg); color: var(--text); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; transition: background 0.3s, color 0.3s; }
        .app-container { width: 100%; max-width: 100%; height: 100vh; background: var(--bg); position: relative; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        .header { padding: 20px; background: var(--card); text-align: center; border-bottom: 1px solid var(--border); position: relative; z-index: 10; }
        .content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 90px; transition: opacity 0.3s; }
        .nav-bar { position: absolute; bottom: 0; width: 100%; height: 70px; background: var(--card); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid var(--border); z-index: 20; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 11px; cursor: pointer; color: var(--text-muted); transition: 0.2s; padding: 8px 5px; border-radius: 8px; flex: 1; text-align: center; }
        .nav-item:hover { background: var(--hover-bg); }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item span { margin-top: 4px; }

        .task-card { background: var(--card); padding: 10px 15px; border-radius: 12px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; border: 1px solid var(--border); transition: transform 0.2s, box-shadow 0.2s; cursor: default; position: relative; overflow: hidden; min-height: 50px; }
        .task-card span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .completed-text { text-decoration: line-through; opacity: 0.5; }

        .recur-badge { font-size: 10px; background: #ede9fe; color: #7c3aed; padding: 2px 6px; border-radius: 12px; font-weight: 700; margin-left: 6px; }
        body.dark-theme .recur-badge { background: #2d1b69; color: #c4b5fd; }

        .fab { position: absolute; bottom: 90px; right: 20px; width: 56px; height: 56px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 12px rgba(74,144,226,0.4); cursor: pointer; z-index: 10; transition: 0.2s; }
        .fab:hover { transform: scale(1.1); filter: brightness(1.1); }

        .help-btn { position: absolute; top: 18px; right: 20px; padding: 6px 14px; background: #FFD700; color: #333; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-weight: bold; font-size: 14px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: none; transition: 0.3s; z-index: 15; animation: pulse 2s infinite; }
        .help-btn:hover { background: #ffcc00; transform: scale(1.05); }
        @keyframes pulse { 0%{box-shadow:0 0 0 0 rgba(255,215,0,.4)} 70%{box-shadow:0 0 0 10px rgba(255,215,0,0)} 100%{box-shadow:0 0 0 0 rgba(255,215,0,0)} }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .modal-content { background: var(--card); padding: 30px; border-radius: 20px; width: 85%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); color: var(--text); max-height: 85vh; display: flex; flex-direction: column; overflow-y: auto; }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; font-size: 14px; transition: 0.2s; background: var(--bg); color: var(--text); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(74,144,226,0.2); }
        .modal-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .btn-save { flex: 1; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-cancel { flex: 1; background: var(--border); color: var(--text); border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .hidden { display: none !important; }

        .task-toolbar { display: flex; flex-direction: row; align-items: center; gap: 8px; margin-bottom: 14px; flex-wrap: nowrap; }
        .task-toolbar input { margin: 0; flex: 1 1 0; min-width: 0; padding: 10px 12px; font-size: 13px; }
        .task-toolbar select { margin: 0; padding: 10px 8px; font-size: 13px; flex: 0 0 auto; width: auto; }
        

        .stat-item { background: var(--hover-bg); padding: 20px; border-radius: 12px; text-align: center; flex: 1; }
        .stat-number { font-size: 28px; font-weight: bold; display: block; color: var(--text); }
        .stat-label { font-size: 13px; color: var(--text-muted); font-weight: 500; }

        .streak-card { background: linear-gradient(135deg, #ff6b35, #f7b731); color: white; padding: 20px; border-radius: 14px; display: flex; align-items: center; gap: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(247,183,49,0.3); }
        .streak-flame { font-size: 40px; animation: flame 1.5s ease-in-out infinite alternate; }
        @keyframes flame { from{transform:scale(1) rotate(-3deg)} to{transform:scale(1.1) rotate(3deg)} }

        .chart-container { background: var(--card); border-radius: 14px; padding: 20px; border: 1px solid var(--border); margin-bottom: 20px; }
        .chart-container canvas { max-height: 200px; }

        .star-btn { cursor: pointer; transition: 0.3s; color: var(--border); font-size: 20px; padding: 5px; }
        .star-btn.is-starred { color: #FFD700; transform: scale(1.2) rotate(15deg); text-shadow: 0 0 10px rgba(255,215,0,0.3); }

        .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 10px; }
        .calendar-nav button { border: none; background: none; font-size: 20px; cursor: pointer; color: var(--primary); padding: 5px 15px; border-radius: 8px; transition: 0.2s; }
        .calendar-nav button:hover { background: var(--hover-bg); }
        .calendar-grid-header { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: bold; color: var(--text-muted); margin-bottom: 15px; font-size: 14px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .calendar-day { padding: 12px 0; font-size: 14px; cursor: pointer; border-radius: 8px; transition: 0.2s; font-weight: 500; position: relative; }
        .calendar-day:hover { background: var(--hover-bg); color: var(--primary); }
        .today-highlight { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(74,144,226,0.3); }
        .has-task-dot::after { content:'‚Ä¢'; display:block; color:var(--primary); margin-top:-5px; font-size:18px; }

        .level-badge { background: linear-gradient(135deg, #FFD700, #FFA500); color: #fff; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; box-shadow: 0 2px 5px rgba(255,165,0,0.4); display: inline-block; }
        .xp-bar-container { width: 100%; background: var(--border); border-radius: 10px; height: 10px; margin-top: 8px; overflow: hidden; }
        .xp-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s ease-out; }

        .sidebar { position: absolute; left: calc(var(--sidebar-width) * -1); top: 0; width: var(--sidebar-width); height: 100%; background: var(--card); z-index: 2000; transition: 0.3s cubic-bezier(0.4,0,0.2,1); box-sizing: border-box; box-shadow: 2px 0 15px rgba(0,0,0,0.2); }
        .sidebar.active { left: 0; }
        .sidebar-overlay { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 1500; backdrop-filter: blur(2px); }
        .sidebar-header { padding: 30px 20px; background: linear-gradient(135deg, var(--primary), #63a4ff); color: white; }
        .sidebar-items { padding: 15px 10px; }
        .sidebar-item { padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; border-radius: 8px; display: flex; align-items: center; gap: 12px; font-weight: 500; color: var(--text); }
        .sidebar-item:hover { background: var(--hover-bg); color: var(--primary); padding-left: 20px; transition: 0.2s; }

        .profile-card { background: var(--card); padding: 25px; border-radius: 15px; display: flex; align-items: center; gap: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .avatar-large { width: 70px; height: 70px; border-radius: 50%; background: var(--border); display: flex; align-items: center; justify-content: center; overflow: hidden; border: 3px solid var(--card); box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; flex-shrink: 0; }
        .login-link { color: var(--primary); cursor: pointer; font-size: 14px; margin-top: 5px; font-weight: 500; }
        .google-btn { width: 100%; padding: 12px; margin-top: 10px; background-color: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 8px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; text-decoration: none; box-sizing: border-box; transition: 0.2s; }
        .google-btn:hover { background: var(--hover-bg); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

        #toast-container { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: var(--card); color: var(--text); padding: 12px 24px; border-radius: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); font-size: 14px; font-weight: bold; display: flex; align-items: center; gap: 10px; border-left: 4px solid var(--primary); animation: slideUp 0.3s ease-out forwards; opacity: 0; }
        .toast.success { border-left-color: #4CAF50; }
        .toast.error { border-left-color: #F44336; }
        .toast.info { border-left-color: #4A90E2; }
        @keyframes slideUp { from{transform:translateY(20px);opacity:0} to{transform:translateY(0);opacity:1} }

        #pomodoro-widget { position: fixed; bottom: 180px; right: 20px; width: 280px; background: var(--card); border-radius: 16px; padding: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); z-index: 500; border: 1px solid var(--border); }
        .widget-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .time-presets { display: flex; gap: 8px; margin-bottom: 15px; }
        .time-presets button { flex: 1; padding: 8px; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 13px; }
        .time-presets button:hover { background: var(--hover-bg); transform: translateY(-2px); }
        .time-presets button.active-preset { background: var(--primary); color: white; border-color: var(--primary); }
        #timer-display { text-align: center; font-size: 48px; font-weight: bold; color: var(--primary); margin: 20px 0; font-family: 'Courier New', monospace; }
        .widget-controls { display: flex; gap: 8px; }
        .widget-controls button { flex: 1; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 13px; }
        .widget-controls button:hover { filter: brightness(1.1); transform: translateY(-2px); }

        input[type="checkbox"] { width: 22px; height: 22px; cursor: pointer; accent-color: var(--primary); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
         

        @media (min-width: 768px) {
            .app-container { max-width: 1000px; height: 90vh; border-radius: 20px; display: grid; grid-template-columns: 100px 1fr; grid-template-rows: auto 1fr; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
            .header { grid-column: 2; grid-row: 1; border-radius: 0 20px 0 0; padding: 25px; }
            .content { grid-column: 2; grid-row: 2; padding: 30px 50px; padding-bottom: 40px; border-radius: 0 0 20px 0; }
            .nav-bar { grid-column: 1; grid-row: 1 / span 2; position: static; height: 100%; flex-direction: column; justify-content: center; gap: 40px; border-top: none; border-right: 1px solid var(--border); border-radius: 20px 0 0 20px; }
            .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 11px; cursor: pointer; color: var(--text-muted); transition: 0.2s; padding: 8px 5px; border-radius: 8px; flex: 0 0 auto; text-align: center; }
            .nav-item span { font-size: 13px; margin-top: 8px; }
            .fab { bottom: 40px; right: 50px; width: 65px; height: 65px; font-size: 30px; }
            #calendar-view, #mine-view { max-width: 700px; margin: 0 auto; }
            #tasks-view { max-width: 800px; margin: 0 auto; }
            .task-card { padding: 12px 20px; }
            .help-btn { top: 25px; right: 25px; }
            #pomodoro-widget { bottom: 120px; right: 50px; }
        }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div class="app-container">
    <div class="header">
        <div style="position:absolute;left:25px;font-size:26px;cursor:pointer;top:50%;transform:translateY(-50%);color:var(--text);transition:0.2s;" onmouseover="this.style.color='var(--primary)'" onmouseout="this.style.color='var(--text)'" onclick="toggleSidebar()">‚ò∞</div>
        <h2 id="view-title" style="margin:0;color:var(--text);">My Tasks</h2>
        <div class="help-btn" onclick="toggleUserGuide()" title="User Guide">?</div>
    </div>

    <div class="content">
        <div id="tasks-view">
            <div class="task-toolbar">
                <input type="text" id="task-search" placeholder="üîç Search tasks..." oninput="applyFilters()">
                <select id="filter-category" onchange="applyFilters()">
                    <option value="">All Categories</option>
                    <option value="Personal">Personal</option>
                    <option value="Work">Work</option>
                    <option value="Wishlist">Wishlist</option>
                    <option value="Birthday">Birthday</option>
                </select>
                <select id="sort-tasks" onchange="applyFilters()">
                    <option value="default">Default</option>
                    <option value="date">By Date</option>
                    <option value="category">By Category</option>
                </select>
            </div>
            <div id="taskList"></div>
        </div>

        <div id="calendar-view" class="hidden">
            <div class="calendar-nav">
                <button onclick="changeMonth(-1)">‚óÄ</button>
                <h3 id="calendar-month-year" style="margin:0;color:var(--text);font-size:18px;"></h3>
                <button onclick="changeMonth(1)">‚ñ∂</button>
            </div>
            <div class="calendar-grid-header">
                <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
            </div>
            <div id="calendar-days" class="calendar-grid"></div>
            <div id="day-tasks-container" style="margin-top:40px;">
                <h4 id="selected-date-label" style="color:var(--primary);border-bottom:2px solid var(--border);padding-bottom:10px;font-size:18px;">Today's Focus</h4>
                <div id="day-task-list"></div>
            </div>
        </div>

        <div id="mine-view" class="hidden">
            <div class="profile-card">
                <div class="avatar-large" onclick="triggerAvatarUpload()" style="cursor:pointer;">
                    <span id="current-avatar-display" style="font-size:35px;">üë§</span>
                    <div style="position:absolute;bottom:0;width:100%;background:rgba(0,0,0,0.6);color:white;font-size:11px;text-align:center;padding:4px 0;font-weight:bold;">EDIT</div>
                </div>
                <input type="file" id="avatar-upload" hidden accept="image/*" onchange="handleAvatarChange(this)">
                <div style="flex:1;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div id="user-status-text" style="font-weight:bold;font-size:20px;color:var(--text);">Welcome!</div>
                        <div id="user-level-badge" class="level-badge">Lv 1 Novice</div>
                    </div>
                    <div class="xp-bar-container">
                        <div id="user-xp-fill" class="xp-bar"></div>
                    </div>
                    <div id="xp-text" style="font-size:10px;color:var(--text-muted);text-align:right;margin-top:2px;">0 / 100 XP</div>
                    <div class="login-link" id="login-link-btn" onclick="openLoginModal()" style="margin-top:8px;">Click to login</div>
                </div>
            </div>

            <div class="streak-card" style="margin-top:20px;">
                <div class="streak-flame">üî•</div>
                <div>
                    <div style="font-size:36px;font-weight:900;line-height:1;" id="streak-count">0</div>
                    <div style="font-size:12px;opacity:0.9;font-weight:600;">DAY STREAK</div>
                </div>
                <div style="margin-left:auto;text-align:right;">
                    <div style="font-size:11px;opacity:0.8;">Best</div>
                    <div style="font-size:22px;font-weight:900;" id="streak-best">0</div>
                </div>
            </div>

            <h4 style="margin:25px 0 15px 0;color:var(--text-muted);font-size:18px;">Tasks Overview</h4>
            <div style="display:flex;gap:15px;margin-bottom:25px;">
                <div class="stat-item"><span id="count-comp" class="stat-number">0</span><span class="stat-label">Completed</span></div>
                <div class="stat-item"><span id="count-pend" class="stat-number">0</span><span class="stat-label">Pending</span></div>
            </div>
            <div class="stat-item" style="display:flex;flex-direction:column;align-items:center;padding:35px;margin-bottom:25px;">
                <div style="position:relative;display:flex;align-items:center;justify-content:center;">
                    <svg width="120" height="120" style="transform:rotate(-90deg);">
                        <circle cx="60" cy="60" r="50" stroke="var(--border)" stroke-width="10" fill="transparent"/>
                        <circle id="progress-circle" cx="60" cy="60" r="50" stroke="var(--primary)" stroke-width="10" fill="transparent" stroke-dasharray="314.16" stroke-dashoffset="314.16" stroke-linecap="round" style="transition:stroke-dashoffset 0.8s ease-out;"/>
                    </svg>
                    <div id="perc-text" style="position:absolute;font-size:22px;font-weight:bold;color:var(--primary);">0%</div>
                </div>
                <span class="stat-label" style="margin-top:15px;font-size:14px;">Total Completion Rate</span>
            </div>

            <div class="chart-container">
                <h4 style="margin:0 0 15px 0;color:var(--text);font-size:16px;">üìä Weekly Progress (Last 7 Days)</h4>
                <canvas id="weekly-chart"></canvas>
            </div>

            <h4 style="margin:25px 0 10px 0;color:var(--text-muted);font-size:18px;">üíæ Data Backup</h4>
            <div style="display:flex;gap:8px;">
                <button onclick="exportToJSON()" style="flex:1;padding:10px;background:var(--card);border:1px solid var(--border);border-radius:10px;cursor:pointer;font-size:13px;font-weight:600;color:var(--text);">üìÑ Export JSON</button>
            </div>
        </div>

    </div>


    <div class="fab" onclick="openModal()">+</div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchTab('tasks','My Tasks',this)"><span style="font-size:20px;margin-bottom:2px;">üìã</span><span>Tasks</span></div>
        <div class="nav-item" onclick="switchTab('calendar','Schedule',this)"><span style="font-size:20px;margin-bottom:2px;">üìÖ</span><span>Calendar</span></div>
        <div class="nav-item" onclick="switchTab('mine','Profile',this)"><span style="font-size:20px;margin-bottom:2px;">üë§</span><span>Mine</span></div>
    </div>
</div>

<div id="pomodoro-widget" class="hidden">
    <div class="widget-header">
        <span style="font-size:14px;font-weight:bold;">üçÖ Focus Timer</span>
        <span style="cursor:pointer;font-size:18px;color:var(--text-muted);" onclick="toggleWidget()">‚úï</span>
    </div>
    <div class="time-presets">
        <button onclick="setTimerDuration(5,this)">5m</button>
        <button onclick="setTimerDuration(15,this)">15m</button>
        <button onclick="setTimerDuration(25,this)" class="active-preset">25m</button>
        <button onclick="setTimerDuration(50,this)">50m</button>
    </div>
    <div id="timer-display">25:00</div>
    <div class="widget-controls">
        <button onclick="startTimer()">Start</button>
        <button onclick="pauseTimer()">Pause</button>
        <button onclick="resetTimer()">Reset</button>
    </div>
</div>

<div id="taskModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;color:var(--text);">New Task</h3>
        <input type="text" id="new_task_name" placeholder="What needs to be done?">
        <label style="display:block;margin-top:10px;color:var(--text-muted);"><small>Category</small></label>
        <select id="new_task_category">
            <option value="Personal">Personal</option>
            <option value="Work">Work</option>
            <option value="Wishlist">Wishlist</option>
            <option value="Birthday">Birthday</option>
        </select>
        <label style="display:block;margin-top:10px;color:var(--text-muted);"><small>Due Date</small></label>
        <input type="date" id="new_task_date">
        <label style="display:block;margin-top:10px;color:var(--text-muted);"><small>Repeat</small></label>
        <select id="task_recur_type">
            <option value="none">No repeat</option>
            <option value="daily">Daily</option>
            <option value="weekly">Every week</option>
            <option value="monthly">Monthly</option>
        </select>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeModal()">Cancel</button>
            <button class="btn-save" onclick="saveTask()">Save Task</button>
        </div>
    </div>
</div>

<div id="loginModal" class="modal">
    <div class="modal-content">
        <h3 style="text-align:center;color:var(--primary);">Account Sync</h3>
        <a href="/auth/google" class="google-btn">
            <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google" style="width:18px;height:18px;">
            Sign in with Google
        </a>
        <button class="btn-cancel" onclick="closeLoginModal()" style="width:100%;margin-top:15px;">Cancel</button>
    </div>
</div>

<div id="guideModal" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--primary);margin-top:0;">Quick User Guide</h3>
        <ul style="text-align:left;font-size:14px;line-height:1.8;padding-left:20px;color:var(--text);">
            <li><strong>Recurring:</strong> Tasks repeat daily, weekly, or monthly</li>
            <li><strong>Search & Filter:</strong> Use toolbar to find tasks quickly</li>
            <li><strong>Streak:</strong> Complete tasks daily to grow üî• streak</li>
            <li><strong>Charts:</strong> View weekly progress on Profile tab</li>
            <li><strong>Export:</strong> Save tasks to JSON format</li>
            <li><strong>Focus Timer:</strong> Click üçÖ in sidebar for Pomodoro</li>
        </ul>
        <button class="btn-save" style="width:100%;margin-top:10px;" onclick="toggleUserGuide()">Got it!</button>
    </div>
</div>

<div id="feedbackModal" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--primary);text-align:center;margin-top:0;">Send Feedback</h3>
        <p style="font-size:12px;color:var(--text-muted);text-align:center;">How can we improve your experience?</p>
        <textarea id="feedbackText" rows="4" placeholder="Your suggestions..."></textarea>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeFeedbackModal()">Cancel</button>
            <button class="btn-save" onclick="submitFeedback()">Send</button>
        </div>
    </div>
</div>

<div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
<div id="sidebar-menu" class="sidebar">
    <div class="sidebar-header">
        <h3 style="margin:0;font-size:22px;">Daily-Routine</h3>
        <small style="opacity:0.8;">v3.0</small>
    </div>
    <div class="sidebar-items">
        <div class="sidebar-item" onclick="loadStarredOnly()"><span style="width:30px;font-size:18px;">‚≠ê</span> Starred Tasks</div>
        <div class="sidebar-item" onclick="filterByCategory()"><span style="width:30px;font-size:18px;">üìÅ</span> Category</div>
        <div class="sidebar-item" onclick="openFeedbackModal()"><span style="width:30px;font-size:18px;">üìù</span> Feedback</div>
        <div class="sidebar-item" onclick="toggleDarkMode()"><span style="width:30px;font-size:18px;">üé®</span> Dark Mode</div>
        <div class="sidebar-item" onclick="toggleWidget()"><span style="width:30px;font-size:18px;">üçÖ</span> Focus Timer</div>
    </div>
</div>

<script>
const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:3000' : 'https://daily-routine-production.up.railway.app';
let allTasksCache = [];
let weeklyChartInstance = null;
let currentViewingDate = new Date();

// POMODORO
let timerInterval, currentDuration = 25*60, timeLeft = currentDuration;
function toggleWidget(){const w=document.getElementById('pomodoro-widget');w.classList.toggle('hidden');const s=document.getElementById('sidebar-menu');if(s.classList.contains('active'))toggleSidebar();}
function setTimerDuration(m,btn){if(timerInterval)pauseTimer();currentDuration=m*60;timeLeft=currentDuration;updateTimerDisplay();document.querySelectorAll('.time-presets button').forEach(b=>b.classList.remove('active-preset'));if(btn)btn.classList.add('active-preset');}
function updateTimerDisplay(){document.getElementById('timer-display').innerText=`${Math.floor(timeLeft/60).toString().padStart(2,'0')}:${(timeLeft%60).toString().padStart(2,'0')}`;}
function startTimer(){if(timerInterval)return;timerInterval=setInterval(()=>{if(timeLeft>0){timeLeft--;updateTimerDisplay();}else{clearInterval(timerInterval);timerInterval=null;showToast("Time's up!","success");resetTimer();}},1000);}
function pauseTimer(){clearInterval(timerInterval);timerInterval=null;}
function resetTimer(){pauseTimer();timeLeft=currentDuration;updateTimerDisplay();}

// DARK MODE
if(localStorage.getItem('theme')==='dark')document.body.classList.add('dark-theme');
function toggleDarkMode(){document.body.classList.toggle('dark-theme');const d=document.body.classList.contains('dark-theme');localStorage.setItem('theme',d?'dark':'light');toggleSidebar();showToast(d?"Dark Mode":"Light Mode","info");}

// MODALS
function openModal(){document.getElementById('taskModal').style.display='flex';document.getElementById('new_task_date').value=new Date().toISOString().split('T')[0];}
function closeModal(){document.getElementById('taskModal').style.display='none';document.getElementById('new_task_name').value='';}
function openLoginModal(){document.getElementById('loginModal').style.display='flex';}
function closeLoginModal(){document.getElementById('loginModal').style.display='none';}
function toggleUserGuide(){const m=document.getElementById('guideModal');m.style.display=(m.style.display==='flex')?'none':'flex';}
function openFeedbackModal(){toggleSidebar();document.getElementById('feedbackModal').style.display='flex';}
function closeFeedbackModal(){document.getElementById('feedbackModal').style.display='none';document.getElementById('feedbackText').value='';}

async function submitFeedback(){
    const fb=document.getElementById('feedbackText').value.trim();if(!fb)return showToast("Enter feedback.","error");
    const user=localStorage.getItem('currentUser')||'Guest';
    try{await emailjs.send("service_pvpl3m2","template_pvpl3m2",{from_name:user,message:fb,reply_to:"no-reply@dailyroutine.com"});showToast("Feedback sent!","success");closeFeedbackModal();}
    catch(e){showToast("Failed.","error");}
}

// TAB SWITCHING
function switchTab(tabId,title,element){
    const content=document.querySelector('.content');content.style.opacity='0';
    setTimeout(()=>{
        document.getElementById('view-title').innerText=title;
        ['tasks-view','calendar-view','mine-view'].forEach(id=>document.getElementById(id).classList.add('hidden'));
        document.getElementById(tabId+'-view').classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));element.classList.add('active');
        if(tabId==='calendar')generateCalendar();
        if(tabId==='mine'){updateStats();updateStreakUI();}
        if(tabId==='tasks')loadTasks();
        content.style.opacity='1';
    },150);
}

function toggleSidebar(){const s=document.getElementById('sidebar-menu');const o=document.getElementById('sidebar-overlay');s.classList.toggle('active');o.style.display=s.classList.contains('active')?'block':'none';}
function triggerAvatarUpload(){document.getElementById('avatar-upload').click();}
function handleAvatarChange(input){if(input.files&&input.files[0]){if(input.files[0].size>2*1024*1024)return showToast("File too large!","error");const r=new FileReader();r.onload=e=>{localStorage.setItem('userAvatar',e.target.result);updateAvatarDisplay(e.target.result);showToast("Avatar updated!","success");};r.readAsDataURL(input.files[0]);}}
function updateAvatarDisplay(img){document.getElementById('current-avatar-display').innerHTML=`<img src="${img}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;}

function renderTasksList(tasks){
    const container=document.getElementById('taskList');
    if(!tasks.length){container.innerHTML='<div style="text-align:center;padding:80px 20px;color:var(--text-muted);"><div style="font-size:60px;margin-bottom:15px;">üìã</div><p style="font-size:16px;">No tasks yet. Click + to add one!</p></div>';return;}
    container.innerHTML='';
    tasks.forEach(task=>{
        const isDone=task.isCompleted?'completed-text':'';
        const starClass=(task.isStarred===true||task.isStarred==1)?'is-starred':'';
        const recurBadge=(task.recurType&&task.recurType!=='none')?`<span class="recur-badge">üîÑ ${task.recurType}</span>`:'';
        container.innerHTML+=`<div class="task-card" data-id="${task.id}">
            <input type="checkbox" ${task.isCompleted?'checked':''} onchange="toggleTask(${task.id},this)">
            <div class="${isDone}" style="flex:1;padding-left:5px;">
                <strong style="font-size:16px;color:var(--text);">${task.task_name}</strong>
                ${recurBadge}<br>
                <small style="color:var(--text-muted);display:inline-block;margin-top:5px;">üè∑Ô∏è ${task.category} &nbsp;|&nbsp; üìÖ ${task.date||'No Date'}</small>
            </div>
            <span onclick="toggleStar(${task.id})" class="star-btn ${starClass}">‚≠ê</span>
            <span onclick="deleteTask(${task.id})" style="color:#ff4d4d;cursor:pointer;font-weight:bold;padding:10px;font-size:18px;">‚úï</span>
        </div>`;
    });
}

function applyFilters(){
    const search=document.getElementById('task-search').value.toLowerCase();
    const cat=document.getElementById('filter-category').value;
    const sort=document.getElementById('sort-tasks').value;
    let tasks=[...allTasksCache];
    if(search)tasks=tasks.filter(t=>t.task_name.toLowerCase().includes(search)||(t.category||'').toLowerCase().includes(search));
    if(cat)tasks=tasks.filter(t=>t.category===cat);
    if(sort==='date')tasks.sort((a,b)=>(a.date||'9999')>(b.date||'9999')?1:-1);
    else if(sort==='category')tasks.sort((a,b)=>(a.category||'').localeCompare(b.category||''));
    renderTasksList(tasks);
}

// LOAD TASKS
async function loadTasks(){
    try{
        const user=localStorage.getItem('currentUser')||'guest';
        const res=await fetch(`${API_URL}/display?username=${user}`);
        if(!res.ok)throw new Error();
        allTasksCache=await res.json();
        applyFilters();
    }catch(e){document.getElementById('taskList').innerHTML='<div style="text-align:center;padding:80px 20px;color:var(--text-muted);"><div style="font-size:50px;margin-bottom:15px;">‚ö†Ô∏è</div><p>Could not connect to server.</p></div>';}
}

async function saveTask(){
    const name=document.getElementById('new_task_name').value.trim();if(!name)return showToast("Task name required","error");
    const user=localStorage.getItem('currentUser')||'guest';
    const recurType=document.getElementById('task_recur_type').value;
    try{
        const res=await fetch(`${API_URL}/add`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({task_name:name,username:user,category:document.getElementById('new_task_category').value,date:document.getElementById('new_task_date').value,isCompleted:false,isStarred:false,recurType})});
        if(!res.ok)throw new Error();
        closeModal();
        await loadTasks();
        showToast("Task saved!","success");
        if(recurType!=='none')generateRecurringTasks(await res.json());
    }catch(e){showToast("Failed to save task.","error");}
}

async function generateRecurringTasks(task){
    if(!task.recurType||task.recurType==='none'||!task.date)return;
    const user=localStorage.getItem('currentUser')||'guest';
    const baseDate=new Date(task.date);
    const today=new Date();today.setHours(0,0,0,0);
    const endDate=new Date(today);endDate.setDate(endDate.getDate()+30);
    const dates=[];
    let d=new Date(baseDate);d.setDate(d.getDate()+1);
    while(d<=endDate){
        dates.push(new Date(d));
        if(task.recurType==='daily')d.setDate(d.getDate()+1);
        else if(task.recurType==='weekly')d.setDate(d.getDate()+7);
        else if(task.recurType==='monthly')d.setMonth(d.getMonth()+1);
        else break;
    }
    for(const date of dates){
        const dateStr=date.toISOString().split('T')[0];
        try{await fetch(`${API_URL}/add`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({task_name:task.task_name,username:user,category:task.category,date:dateStr,isCompleted:false,isStarred:false,recurType:task.recurType})});}catch(e){}
    }
    loadTasks();
}

async function toggleTask(id,checkboxEl){
    const isChecked=checkboxEl.checked;
    const textDiv=checkboxEl.closest('.task-card').querySelector('div');
    if(isChecked)textDiv.classList.add('completed-text');else textDiv.classList.remove('completed-text');
    try{
        await fetch(`${API_URL}/toggle/${id}`,{method:'PATCH'});
        updateStats();
        if(isChecked){addXP(10);recordCompletionDate();updateStreakUI();}
    }catch(err){checkboxEl.checked=!isChecked;if(isChecked)textDiv.classList.remove('completed-text');else textDiv.classList.add('completed-text');showToast("Error saving.","error");}
}

async function deleteTask(id){if(confirm("Delete task?")){try{await fetch(`${API_URL}/delete/${id}`,{method:'DELETE'});loadTasks();updateStats();showToast("Task deleted.","info");}catch(e){showToast("Failed.","error");}}}
async function toggleStar(id){try{const res=await fetch(`${API_URL}/star/${id}`,{method:'PATCH'});if(res.ok)loadTasks();}catch(e){}}

async function filterByCategory(){const cat=prompt("Enter category:");if(!cat)return;toggleSidebar();document.getElementById('view-title').innerText=cat+" Tasks";['tasks-view','calendar-view','mine-view'].forEach(id=>document.getElementById(id).classList.add('hidden'));document.getElementById('tasks-view').classList.remove('hidden');renderTasksList(allTasksCache.filter(t=>t.category.toLowerCase()===cat.toLowerCase()));}
async function loadStarredOnly(){toggleSidebar();document.getElementById('view-title').innerText="Starred Tasks";['tasks-view','calendar-view','mine-view'].forEach(id=>document.getElementById(id).classList.add('hidden'));document.getElementById('tasks-view').classList.remove('hidden');renderTasksList(allTasksCache.filter(t=>t.isStarred===true||t.isStarred==1));}

// STATS
async function updateStats(){
    try{
        const user=localStorage.getItem('currentUser')||'guest';
        const res=await fetch(`${API_URL}/display?username=${user}`);
        if(!res.ok)return;
        const tasks=await res.json();allTasksCache=tasks;
        const total=tasks.length,completed=tasks.filter(t=>t.isCompleted).length,pending=total-completed;
        const perc=total>0?Math.round((completed/total)*100):0;
        animateNumber('count-comp',completed);animateNumber('count-pend',pending);animateNumber('perc-text',perc,'%');
        const circle=document.getElementById('progress-circle');
        if(circle)circle.style.strokeDashoffset=314.16-(perc/100)*314.16;
        renderCharts();
    }catch(e){}
}

function animateNumber(id,end,suffix=''){const obj=document.getElementById(id);if(!obj)return;let start=null;const step=ts=>{if(!start)start=ts;const p=Math.min((ts-start)/500,1);obj.innerHTML=Math.floor(p*end)+suffix;if(p<1)requestAnimationFrame(step);};requestAnimationFrame(step);}

// STREAK
function computeStreak(completedDates){if(!completedDates||!completedDates.length)return{streak:0,best:0};const uniqueDays=[...new Set(completedDates)].sort().reverse();let streak=0,best=0,current=0;const today=new Date().toISOString().split('T')[0];let prev=today;for(let d of uniqueDays){const diff=(new Date(prev)-new Date(d))/86400000;if(diff<=1){current++;prev=d;}else break;}streak=current;let run=1;for(let i=1;i<uniqueDays.length;i++){const diff=(new Date(uniqueDays[i-1])-new Date(uniqueDays[i]))/86400000;if(diff===1){run++;if(run>best)best=run;}else{if(run>best)best=run;run=1;}}if(run>best)best=run;if(streak>best)best=streak;return{streak,best};}
function updateStreakUI(){const completedDates=JSON.parse(localStorage.getItem('completed_dates'))||[];const{streak,best}=computeStreak(completedDates);document.getElementById('streak-count').textContent=streak;document.getElementById('streak-best').textContent=best;}
function recordCompletionDate(){const today=new Date().toISOString().split('T')[0];const completedDates=JSON.parse(localStorage.getItem('completed_dates'))||[];if(!completedDates.includes(today)){completedDates.push(today);localStorage.setItem('completed_dates',JSON.stringify(completedDates));}}

// GAMIFICATION
function updateGamificationUI(){let xp=parseInt(localStorage.getItem('userXP'))||0;let level=parseInt(localStorage.getItem('userLevel'))||1;let xpReq=level*100;document.getElementById('user-level-badge').innerText=`Lv ${level} ${getRankName(level)}`;document.getElementById('user-xp-fill').style.width=`${(xp/xpReq)*100}%`;document.getElementById('xp-text').innerText=`${xp} / ${xpReq} XP`;}
function getRankName(l){if(l<3)return"Novice";if(l<5)return"Planner";if(l<10)return"Achiever";return"Master";}
function addXP(amount){let xp=parseInt(localStorage.getItem('userXP'))||0;let level=parseInt(localStorage.getItem('userLevel'))||1;let xpReq=level*100;xp+=amount;if(xp>=xpReq){xp=xp-xpReq;level++;showToast(`üéâ LEVEL UP! Level ${level}!`,"success");localStorage.setItem('userLevel',level);}else showToast(`+${amount} XP`,"success");localStorage.setItem('userXP',xp);updateGamificationUI();}

// CHARTS
function buildWeeklyChartData(){const labels=[],counts=[];for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const ds=d.toISOString().split('T')[0];labels.push(d.toLocaleDateString('en-US',{weekday:'short'}));counts.push(allTasksCache.filter(t=>t.isCompleted&&t.date===ds).length);}return{labels,counts};}
function renderCharts(){const isDark=document.body.classList.contains('dark-theme');const gridColor=isDark?'rgba(255,255,255,0.08)':'rgba(0,0,0,0.06)';const labelColor=isDark?'#aaa':'#666';const wCtx=document.getElementById('weekly-chart');if(wCtx){const{labels,counts}=buildWeeklyChartData();if(weeklyChartInstance)weeklyChartInstance.destroy();weeklyChartInstance=new Chart(wCtx,{type:'bar',data:{labels,datasets:[{label:'Completed',data:counts,backgroundColor:'rgba(74,144,226,0.7)',borderRadius:6,borderSkipped:false}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{ticks:{color:labelColor,stepSize:1},grid:{color:gridColor},beginAtZero:true},x:{ticks:{color:labelColor},grid:{display:false}}}}});}}

// CALENDAR
async function generateCalendar(){const container=document.getElementById('calendar-days');container.innerHTML='';const year=currentViewingDate.getFullYear();const month=currentViewingDate.getMonth();document.getElementById('calendar-month-year').innerText=currentViewingDate.toLocaleDateString('en-US',{month:'long',year:'numeric'});let tasks=[];try{const user=localStorage.getItem('currentUser')||'guest';const res=await fetch(`${API_URL}/display?username=${user}`);if(res.ok)tasks=await res.json();}catch(e){}const daysInMonth=new Date(year,month+1,0).getDate();const firstDay=new Date(year,month,1).getDay();const today=new Date();for(let i=0;i<firstDay;i++)container.appendChild(document.createElement('div'));for(let i=1;i<=daysInMonth;i++){const dayEl=document.createElement('div');dayEl.classList.add('calendar-day');dayEl.innerText=i;const dateString=`${year}-${(month+1).toString().padStart(2,'0')}-${i.toString().padStart(2,'0')}`;if(year===today.getFullYear()&&month===today.getMonth()&&i===today.getDate())dayEl.classList.add('today-highlight');if(tasks.some(t=>t.date===dateString))dayEl.classList.add('has-task-dot');dayEl.onclick=()=>showTasksForDay(dateString,tasks);container.appendChild(dayEl);}showTasksForDay(`${year}-${(month+1).toString().padStart(2,'0')}-${today.getDate().toString().padStart(2,'0')}`,tasks);}
function changeMonth(dir){currentViewingDate.setMonth(currentViewingDate.getMonth()+dir);generateCalendar();}
function showTasksForDay(dateStr,allTasks){const list=document.getElementById('day-task-list');const label=document.getElementById('selected-date-label');list.innerHTML='';label.innerText=`Tasks for ${dateStr}`;const filtered=allTasks.filter(t=>t.date===dateStr);if(!filtered.length){list.innerHTML='<p style="color:var(--text-muted);font-size:0.9em;padding:10px 0;">No tasks for this day.</p>';return;}filtered.forEach(t=>{list.innerHTML+=`<div style="background:var(--hover-bg);padding:15px;border-radius:10px;margin-bottom:8px;border-left:4px solid var(--primary);display:flex;justify-content:space-between;align-items:center;"><div style="flex:1;"><strong style="font-size:15px;color:var(--text);">${t.task_name}</strong><small style="background:var(--card);color:var(--primary);border:1px solid var(--border);padding:4px 8px;border-radius:12px;font-weight:bold;margin-left:8px;">${t.category}</small></div></div>`;});}

// TOAST
function showToast(message,type='info'){const c=document.getElementById('toast-container');const t=document.createElement('div');t.className=`toast ${type}`;const icons={success:'‚úÖ',error:'‚ö†Ô∏è',info:'‚ÑπÔ∏è'};t.innerHTML=`<span>${icons[type]||'‚ÑπÔ∏è'}</span><span>${message}</span>`;c.appendChild(t);setTimeout(()=>t.remove(),3000);}

// EXPORT (JSON ONLY)
function exportToJSON(){const data={exported:new Date().toISOString(),tasks:allTasksCache};const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`daily-routine-backup-${new Date().toISOString().split('T')[0]}.json`;a.click();URL.revokeObjectURL(url);showToast("JSON exported!","success");}

window.onload=()=>{
    const urlParams=new URLSearchParams(window.location.search);
    const googleUser=urlParams.get('username');
    if(googleUser){localStorage.setItem('currentUser',googleUser);window.history.replaceState({},document.title,"/");showToast("Logged in!","success");}
    const user=localStorage.getItem('currentUser');
    if(user){const st=document.getElementById('user-status-text');const lb=document.getElementById('login-link-btn');if(st)st.innerText=`Great job, ${user}!`;if(lb){lb.innerText="Logout";lb.style.color="#ff4d4d";lb.onclick=()=>{if(confirm("Logout?")){localStorage.removeItem('currentUser');localStorage.removeItem('userAvatar');location.reload();}};}}
    const savedAvatar=localStorage.getItem('userAvatar');if(savedAvatar)updateAvatarDisplay(savedAvatar);
    updateGamificationUI();
    loadTasks();generateCalendar();updateStats();updateStreakUI();
};
</script>

</body>
</html>
